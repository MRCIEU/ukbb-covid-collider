---
title: UK Biobank example of collider bias in Covid-19 test data
bibliography: library.bib
output:
  html_document:
    toc: true
    toc_float: true
---

```{r}
suppressMessages(suppressPackageStartupMessages({
	library(knitr)
	library(dplyr)
	library(ggplot2)
}))

knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=TRUE, cache=TRUE)
```

## About this document

This document forms part of the analysis used in the paper:

**Collider bias undermines our understanding of COVID-19 disease risk and severity**. Gareth Griffith, Tim T Morris, Matt Tudball, Annie Herbert, Giulia Mancano, Lindsey Pike, Gemma C Sharp, Tom M Palmer, George Davey Smith, Kate Tilling, Luisa Zuccolo, Neil M Davies, Gibran Hemani

It is hosted at https://github.com/MRCIEU/ukbb-covid-collider.

The data used in the analysis can be downloaded from: <TBD>

Here we show a set of analyses to illustrate collider bias induced by non-random testing of Covid-19 status amongst the UK Biobank participants, and some approaches to adjust for the bias. The methods are described in further detail in @Griffith2020.05.04.20090506.

The following variables from the [UK biobank phenotype data](http://biobank.ctsu.ox.ac.uk/crystal/) are used:

- `34-0.0` - Year of birth (converted into age for this analysis)
- `31-0.0` - Sex (male = 1, female = 0)
- `23104-0.0` - Body mass index (BMI)

Also, the linked Covid-19 freeze from `2020-06-05` is used to identify which individuals have been tested.

The analysis that follows will look at simple associations between age, sex and BMI in the entire UK Biobank sample, contrasted against their associations amongst individuals selected to be tested.


## Read in the data

```{r}
load("data/dat.rdata")
dat <- dat[complete.cases(dat), ]
str(dat)
```

Summaries:

```{r}
hist(dat$age)
table(dat$sex) / nrow(dat)
```

How many individuals tested:

```{r}
table(dat$tested)
```

## Illustration of collider bias
Age, sex and BMI all strongly influence the likelihood of being tested:

```{r}
summary(glm(tested ~ age + sex + bmi, data=dat, family="binomial"))
```

Hence we would expect the relationships between these variables to be skewed within the tested sample. For example, this is the relationship between age and sex in the total sample

```{r}
mod1 <- summary(lm(age ~ sex, dat))
coefficients(mod1) %>% kable
```

And here it is amongst only those tested:

```{r}
mod2 <- summary(lm(age ~ sex, dat, subset=dat$tested==1))
coefficients(mod2) %>% kable
```

Note that the association is around **`r round(coefficients(mod2)[2,1] / coefficients(mod1)[2,1])` times larger** in the tested subset.

Similarly, this is the overall association between age and BMI:

```{r}
mod3 <- summary(lm(bmi ~ sex, dat))
coefficients(mod3) %>% kable
```

and here in the subsample:

```{r}
mod4 <- summary(lm(bmi ~ sex, dat, subset=dat$tested==1))
coefficients(mod4) %>% kable
```

where the association almost halves.


## Inverse probability weights

If the tested individuals are a subset of the entire sample, then it is possible to generate probabilities for individuals being included in the tested subsample based on the colliding variables. The inverse of these probabilities can be used to weight the association estimate towards being representative of the overall sample.

First find which variables associate with being tested. Begin with marginal effects

```{r}
mod5 <- glm(tested ~ age + sex + bmi, data=dat, family="binomial")
coefficients(summary(mod5)) %>% kable
```

It's important to also test for interactions between variables [@Groenwold2020].

```{r}
mod6 <- glm(tested ~ bmi + age + sex + bmi * age + bmi * sex + age * sex, data=dat, family="binomial")
coefficients(summary(mod6)) %>% kable
```

Curiously the marginal BMI effect appears to be captured by interaction terms only. Centering the marginal variables may be more appropriate when estimating interactions

```{r}
dat$bmixage <- scale(dat$bmi) * scale(dat$age)
dat$bmixsex <- scale(dat$bmi) * scale(dat$sex)
dat$agexsex <- scale(dat$age) * scale(dat$sex)
mod7 <- glm(tested ~ bmi + age + sex + bmixage + bmixsex + agexsex, data=dat, family="binomial")
coefficients(summary(mod7)) %>% kable
```

Here the marginal effects are all retained. The `bmi x sex` interaction doesn't associate strongly, so the final weighting model can be written as:

```{r}
dat$bmixage <- scale(dat$bmi) * scale(dat$age)
dat$bmixsex <- scale(dat$bmi) * scale(dat$sex)
dat$agexsex <- scale(dat$age) * scale(dat$sex)
mod8 <- glm(tested ~ bmi + age + sex + bmixage + agexsex, data=dat, family="binomial")
coefficients(summary(mod8)) %>% kable
```

We can generate the probabilities of each individual being tested based on these variables using:

```{r}
prs <- fitted.values(mod8)
hist(prs, breaks=100)
```

The probabilities are largely clustered close to zero, so when using the inverse of these probabilities for weights there can be potential instability that comes from dividing by small numbers. Stabilising the weight, by multiplying by the probability of being tested, can avoid this issue [@Sayon-Orea2020].

```{r}
p_tested <- sum(dat$tested) / nrow(dat)
weight <- p_tested / prs
```


### Re-analysis of age and sex


Re-estimate the age-sex association with weights

```{r}
mod9 <- summary(lm(age ~ sex, dat, weight=weight, subset=tested==1))
coefficients(mod9) %>% kable
```

Comparisons:

```{r}
create_row <- function(mod, what)
{
	tibble(
		what=what,
		beta=mod$coefficients[2,1],
		lci=beta - mod$coefficients[2,2] * 1.96,
		uci=beta + mod$coefficients[2,2] * 1.96,
	)
}
rbind(
	create_row(mod=mod1, what="Full UK Biobank sample"),
	create_row(mod=mod2, what="Tested subset"),
	create_row(mod=mod9, what="Weighted tested subset")
) %>% kable
```

### Sex and BMI


Now re-estimate the BMI-sex association with in a weighted regression, using the inverse of the `prs` variable as the weights:

```{r}
mod11 <- summary(lm(bmi ~ sex, dat, weight=weight, subset=tested==1))
coefficients(mod11) %>% kable
```

Comparisons:

```{r}
rbind(
	create_row(mod=mod3, what="Full UK Biobank sample"),
	create_row(mod=mod4, what="Tested subset"),
	create_row(mod=mod11, what="Weighted tested subset")
) %>% kable
```

## Summary

The age-sex and BMI-sex associations are distorted within the samples tested for covid, likely because these variables influence inclusion into the sample. We show that inverse probability weighting the individuals in the sample based on the variables that influence inclusion can help to reduce the collider bias. 

Including the interaction term between age and sex when generating the probabilities is important [@Groenwold2020], and this can be easily overlooked.

For age and sex it is implausible that unknown factors confound the age-tested or sex-tested relationships. If such factors existed, the model generating the weights would be required to include their effects also. For the BMI-tested relationship this is more plausible. We show here that the original BMI-sex association was recapitulated using simple weights constructed from only the BMI and sex variables, but if that were not the case it might be required that further variables are included in the model that could be confounding the BMI-tested relationship.


## References
